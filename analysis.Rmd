---
title: "Analysis"
output: html_document
date: "2025-04-24"
---

```{r}
library(tidyverse)
```
# Compile data

```{r}
train_labels = rep(c("OFF", "ON"), 25)
col_names = c(paste0("X", as.character(seq(0, 47))), "label", "phase", "run")

sim_data <- setNames(data.frame(matrix(ncol = length(48), nrow = 0)), colnames(col_names))

for(i in c(0:99)){
  train_data <- read.csv(paste0("data/train_sim_", i, ".csv")) %>%
    mutate(label = train_labels,
           phase = "train",
           run = i)
  
  cue_data <- read.csv(paste0("data/cue_sim_", i, ".csv")) %>%
    mutate(label = c("OFF", "OFF", "OFF", "OFF"),
           phase = "cue",
           run = i)
  
  data = rbind(train_data, cue_data)
  
  sim_data <- rbind(sim_data, data)
}

sim_data <- sim_data %>%
  group_by(run) %>%
  mutate(timestep = row_number()) %>%
  filter(timestep != 1)
```

# Correlation matrix

```{r}
last_16 <- sim_data %>%
  filter(timestep %in% as.character(c(39:54))) %>%
  group_by(run) %>%
  mutate(label = paste0(label, "_", row_number()))
```

```{r}
cor_df <- setNames(data.frame(matrix(ncol = 4, nrow = 0)), colnames(c("run", "correlation", "x_label", "y_label")))

for(r in unique(last_16$run)){
  simulation <- last_16 %>% filter(run == r)
  
  for(i in 1:nrow(simulation)){
    x <- as.vector(unlist(simulation[i,1:48]))
    x_lab <- simulation$label[i]
    
    for(j in 1:nrow(simulation)){
      if(j>=i){
        y <- as.vector(unlist(simulation[j,1:48]))
        y_lab <- simulation$label[j]
        cor <- cor(x,y)
        
        temp_df <- data.frame(run = r, correlation = cor, x_label = x_lab, y_label = y_lab)
        cor_df <- rbind(cor_df, temp_df)
        
      } else {
        temp_df <- data.frame(run = r, correlation = NA, x_label = x_lab, y_label = y_lab)
        cor_df <- rbind(cor_df, temp_df)
      }
    }
  }
}
```

```{r}
avg_cor_df <- cor_df %>%
  mutate(x = as.numeric(sub(".*_", "", x_label)),
         y = as.numeric(sub(".*_", "", y_label))) %>%
  filter(!is.na(correlation)) %>%
  group_by(x, y, x_label, y_label) %>%
  summarise(avg_r = mean(correlation))

avg_cor_df$y <- factor(avg_cor_df$y, levels = 16:1)

ggplot(avg_cor_df, aes(x, y, fill=avg_r)) +
  geom_tile() +
  scale_x_discrete(limits = c(1:16), labels = c(rep(c("OFF", "ON"), 6), "OFF", "OFF", "OFF", "OFF")) +
  scale_y_discrete(limits = c(16:1), labels = c(rep(c("OFF", "ON"), 6), "OFF", "OFF", "OFF", "OFF")) +
  # scale_fill_continuous(limits = c(-1,1)) +
  scale_fill_viridis_c(option = "viridis", direction = -1, limits = c(-1,1)) +
  labs(fill = "Avg. R") +
  geom_text(aes(label = round(avg_r, 2)), color = "white", size = 2) + 
  annotate(
    "rect",
    xmin = 0.5, xmax = 13.5,
    ymin = 0.5, ymax = 3.5,
    color = "red",
    fill = NA,
    linetype = "dashed",
    size = 1
  ) +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.grid.major = element_blank())

# ggsave(filename = "figures/avg_cormatrix.png")
```

```{r}
next_step_df <- cor_df %>%
  mutate(x = as.numeric(sub(".*_", "", x_label)),
         y = as.numeric(sub(".*_", "", y_label)),
         x_label = sub("_.*", "", x_label),
         y_label = sub("_.*", "", y_label)) %>%
  filter(y == "14", x %in% c(1:13)) %>%
  rename("possible_input" = x_label) %>%
  select(run, possible_input, correlation) %>%
  mutate(possible_input = factor(possible_input, levels = c("OFF", "ON")))

ggplot(next_step_df, aes(possible_input, correlation)) +
  geom_point(alpha = 0.1) +
  geom_boxplot(alpha=0) +
  scale_y_continuous(limits = c(-0.25,1.1), breaks = seq(-0.25,1,0.25)) +
  labs(x = "State", y = "R") +
  theme_bw() +
  theme(panel.grid.major = element_blank()) +
  stat_compare_means(method = "t.test", label = "p.signif", comparisons = list(c("OFF", "ON")), label.y = c(1))

# ggsave(filename = "figures/next_step_pred.png")
```

```{r}
off_values <- next_step_df %>%
  mutate(fisher_z = 0.5 * (log(1+correlation) - log(1-correlation))) %>%
  filter(possible_input == "OFF")

on_values <- next_step_df %>%
  mutate(fisher_z = 0.5 * (log(1+correlation) - log(1-correlation))) %>%
  filter(possible_input == "ON")

t.test(on_values$fisher_z, off_values$fisher_z, alternative = "greater")
```
